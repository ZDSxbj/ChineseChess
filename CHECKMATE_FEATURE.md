# 将军与将死功能实现说明

## 最新修复 (2025-11-24)

### 问题：已被将死但未提示，导致无限"不能送将"
- **原因**：将死判定只在移动后检查对方，未在回合开始时检查当前方
- **症状**：被将死的一方在自己回合尝试任何移动都会被提示"不能送将！"，但游戏不结束
- **解决方案**：
  1. 新增 `checkCurrentTurnCheckmate()` 方法检查当前回合方是否已被将死
  2. 在 `clickHandler` 开始时调用，如果当前方已被将死则立即结束游戏，不允许任何操作
  3. 在本地模式下，移动后切换回合时异步检查新回合方是否被将死（提前通知）

### 修复逻辑流程
```typescript
// 1. 每次点击前检查（主要防护）
private clickHandler() {
  if (this.checkCurrentTurnCheckmate()) {
    return // 已将死，阻止所有操作，游戏已结束
  }
  // ... 正常点击逻辑
}

// 2. 每次移动后
private move() {
  // ... 执行移动
  
  // 检查对方是否被将军/将死
  if (opponentCheckmated) {
    结束游戏
    return
  } else if (opponentInCheck) {
    showMsg("对方被将军")
  }
  
  // 切换回合
  this.currentRole = 切换回合
  
  // 在本地模式下，提前检查新回合方是否被将死
  if (!this.isNetPlay) {
    setTimeout(() => {
      this.checkCurrentTurnCheckmate()
    }, 10)
  }
}

// 3. 检查将死方法
private checkCurrentTurnCheckmate() {
  确定当前回合颜色
  if (isCheckmate(currentColor)) {
    showMsg("XX方被将死！")
    结束游戏
    return true
  }
  return false
}
```

### 完整的将死检测时机
1. **移动后立即检查对方**：检测刚被移动将死的情况
2. **本地模式回合切换后**：提前通知下一回合方已被将死（10ms 延迟确保 UI 更新）
3. **每次点击操作前**：最终防护，确保被将死方无法进行任何操作

## 功能概述
已成功实现完整的将军检测和将死判定功能，包括防止"送将"的移动验证。

## 主要功能

### 1. 将军检测 (`isInCheck`)
- 检测指定颜色的将/帅是否处于被攻击状态
- **包含将帅碰面检测**：如果将帅在同一列且中间无棋子，则被视为将军状态
- 检查所有对方棋子是否能攻击到己方的将/帅

### 2. 将死检测 (`isCheckmate`)
- 检测是否无法通过任何合法移动解除将军状态
- 遍历所有己方棋子的所有可能移动
- 模拟每步棋并检查是否能解除将军

### 3. 防止送将 (`canEscapeCheck`)
- **移动前验证**：玩家尝试移动时，系统会模拟该移动
- 如果移动后会导致己方被将军（包括将帅碰面），则阻止该移动
- 显示提示："不能送将！"

### 4. 游戏流程集成
- 每次移动后自动检测对方是否被将军
- 如果对方被将军但未被将死，显示提示："红方/黑方被将军！"
- 如果对方被将死，自动结束游戏并宣布胜者

## 修复的问题

### 问题 1：本地对战无胜利提示
- **原因**：UI 只监听了 `NET:GAME:END` 事件，未监听本地的 `GAME:END` 事件
- **解决**：在 `ChessView.vue` 中添加对 `GAME:END` 事件的监听

### 问题 2：将帅碰面时未阻止送将
- **原因**：`isInCheck()` 只检查对方棋子的直接攻击，未考虑将帅碰面
- **解决**：增强 `isInCheck()` 方法，在检查将军状态时优先检测将帅是否碰面

## 测试场景

### 场景 1：将军提示
1. 进入本地对战模式
2. 走出一步会将军对方的棋
3. **预期**：显示"红方/黑方被将军！"的消息提示

### 场景 2：将死判定
1. 设置一个将死局面
2. 走出最后一步将死对方的棋
3. **预期**：显示胜利消息并结束游戏

### 场景 3：防止送将（将帅碰面）
1. 将两个将/帅放在同一列
2. 尝试移开中间的遮挡棋子
3. **预期**：显示"不能送将！"，移动被阻止

### 场景 4：防止送将（一般情况）
1. 己方将/帅受到威胁
2. 尝试移动其他棋子而不解除威胁
3. **预期**：显示"不能送将！"，移动被阻止

## 代码变更

### 文件：`frontend/src/composables/ChessBoard.ts`
- 新增 `isInCheck(color)` 方法：检测将军状态（含将帅碰面）
- 新增 `canEscapeCheck(color)` 方法：检测是否能解除将军
- 新增 `isCheckmate(color)` 方法：检测将死
- 修改 `move()` 方法：
  - 移动前模拟并验证是否会送将
  - 移动后检测对方是否被将军/将死
  - 移除冗余的将帅碰面检查逻辑

### 文件：`frontend/src/views/game/ChessView.vue`
- 新增对 `GAME:END` 事件的监听
- 确保本地对战结束时显示胜利消息

## 技术细节

### 移动验证流程
```
1. 玩家点击棋子并选择目标位置
2. 检查该棋子的移动规则是否允许（isMoveValid）
3. 模拟移动到目标位置
4. 检查移动后己方是否被将军（含将帅碰面）
5. 如果会被将军，撤销模拟并提示"不能送将！"
6. 如果合法，执行移动并记录历史
7. 检查对方是否被将军或将死
8. 显示相应提示或结束游戏
```

### 性能优化建议
- `isInCheck()` 和 `canEscapeCheck()` 涉及大量棋盘遍历
- 对于复杂局面可能有性能影响
- 未来可考虑：
  - 缓存攻击关系图
  - 增量更新而非全量检查
  - 只检查可能影响将军状态的棋子

## 运行测试

启动前端开发服务器：
```powershell
cd frontend
npm install
npm run dev
```

在浏览器中打开应用，选择"本地对战"模式进行测试。
